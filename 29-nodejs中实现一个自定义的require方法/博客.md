# nodejsä¸­å®ç°ä¸€ä¸ªè‡ªå®šä¹‰çš„requireæ–¹æ³•

## 1.å‰è¨€
å¤§å®¶å¯¹nodejsä¸­çš„requireæ–¹æ³•åº”è¯¥ä¸ä¼šé™Œç”Ÿ,è¿™ä¸ªæ–¹æ³•å¯ä»¥ç”¨æ¥å¯¼å…¥nodejsçš„å†…ç½®æ¨¡å—,è‡ªå®šä¹‰æ¨¡å—,ç¬¬ä¸‰æ–¹æ¨¡å—ç­‰,ä½¿ç”¨é¢‘ç‡éå¸¸é«˜,é‚£ä¹ˆè¿™ä¸ªæ–¹æ³•å†…éƒ¨æ˜¯å¦‚ä½•å®ç°çš„å‘¢?æœ¬ç¯‡æ–‡ç« å°±æ˜¯ä»å¤´åˆ°å°¾æ‹†åˆ†å®ç°æµç¨‹,æœ€ç»ˆå®ç°ä¸€ä¸ªè‡ªå®šä¹‰çš„requireæ–¹æ³•çš„

## 2.å‰ç½®æ“ä½œ
å¯¼å…¥æ‰€éœ€çš„nodejså†…ç½®åº“,åˆ†åˆ«ä¸º`fs`åº“ç”¨æ¥åŠ è½½æ–‡ä»¶å†…å®¹,`path`åº“ç”¨äºæ“ä½œè·¯å¾„,`vm`æ¨¡å—æ‰§è¡Œjsä»£ç 
```js
const fs = require('fs')
const path = require('path')
const vm = require('vm')
```

## 3.æ“ä½œæ­¥éª¤æ‹†åˆ†
1. è·¯å¾„åˆ†æ,è§£æå‡ºç»å¯¹è·¯å¾„
2. ç¼“å­˜ä¼˜å…ˆåŸåˆ™,åŠ è½½æ–‡ä»¶çš„æ—¶å€™ä¼˜å…ˆä»ç¼“å­˜ä¸­åŠ è½½
3. æ–‡ä»¶å®šä½,ç¡®å®šå½“å‰æ¨¡å—çš„æ–‡ä»¶ç±»å‹(`js`,`json`ç­‰ç­‰æ–‡ä»¶,æ–¹ä¾¿åç»­è°ƒç”¨å¯¹åº”çš„ç¼–è¯‘å‡½æ•°)
4. ç¼–è¯‘æ‰§è¡Œ,å°†åŠ è½½æ¨¡å—çš„å†…å®¹å˜ä¸ºå¯ä»¥åœ¨å½“å‰æ¨¡å—ä¸­ç›´æ¥ä½¿ç”¨çš„æ•°æ®

## 4.å¼€å§‹åˆ›å»ºè‡ªå®šä¹‰çš„requireæ–¹æ³•

### 1.åˆ›å»ºcustomRequireæ–¹æ³•
```js
function customRequire(moduleName){}
```

### 2.åˆ›å»ºä¸€ä¸ªModuleç±»,ç”¨äºå­˜å‚¨æ¨¡å—ä¿¡æ¯,ä»¥åŠæŒ‚è½½ä¸€äº›è¾…åŠ©æ–¹æ³•
```js
class Module {
  constructor(id) {
    this.id = id
    this.exports = {}
  }
}
```

### 3.æ‰§è¡Œç¬¬ä¸€æ­¥è·¯å¾„åˆ†æ,è§£æå‡ºç»å¯¹è·¯å¾„æ“ä½œ
```js
// ç»™moduleç±»æ·»åŠ ä¸€ä¸ªé™æ€å±æ€§,ç”¨äºè¡¨ç¤ºæ¨¡å—çš„åŠ è½½å‡½æ•°ä»¥åŠæ¨¡å—åç¼€çš„åŠ è½½é¡ºåº
Module._extensions = {
  '.js'(module) {},
  '.json'(module) {},
  // ...
}

// åˆ›å»ºè¾…åŠ©æ–¹æ³•,ç”¨äºè§£æå¯¼å…¥æ¨¡å—çš„ç»å¯¹è·¯å¾„
Module._resolveFilename = (moduleName) => {
  // è·å–å½“å‰æ¨¡å—çš„ç»å¯¹è·¯å¾„
  let filePath = path.resolve(__dirname, moduleName)
  // è·å–å½“å‰æ¨¡å—çš„åç¼€å
  const extName = path.extname(moduleName)

  // åˆ¤æ–­æ–‡ä»¶æ˜¯å¦å­˜åœ¨
  if (!fs.existsSync(filePath)) {
    // å¦‚æœæ–‡ä»¶ä¸å­˜åœ¨,åˆ™æŒ‰ç…§é¡ºåºæŸ¥æ‰¾åç¼€å
    const keys = Object.keys(Module._extensions)
    // æ–‡ä»¶æ˜¯å¦å­˜åœ¨æ ‡è¯†
    let flag = false
    for (let i = 0; i < keys.length; i++) {
      // è·å–å½“å‰å¾ªç¯çš„åç¼€å
      const currentExtName = keys[i]
      // æ‹¼æ¥åç¼€å
      const currentFilePath = filePath + currentExtName
      // åˆ¤æ–­æ‹¼æ¥åç¼€åä¹‹åçš„æ–‡ä»¶è·¯å¾„æ˜¯å¦å­˜åœ¨
      if (fs.existsSync(currentFilePath)) {
        // å¦‚æœå­˜åœ¨,åˆ™å°†å½“å‰æ–‡ä»¶è·¯å¾„èµ‹å€¼ç»™filePath
        filePath = currentFilePath
        // å°†æ–‡ä»¶æ˜¯å¦å­˜åœ¨æ ‡è¯†è®¾ç½®ä¸ºtrue
        flag = true
        // ç»ˆæ­¢å¾ªç¯
        break
      }
    }
    // å¦‚æœä¸å­˜åœ¨,åˆ™è¿›è¡ŒæŠ¥é”™
    if (!flag) {
      throw new Error(`${moduleName} is not exists`)
    }
  }

  // è¿”å›å¤„ç†åå¾—åˆ°çš„æ–‡ä»¶çš„ç»å¯¹è·¯å¾„
  return filePath
}

// åˆ›å»ºè‡ªå®šä¹‰çš„requireæ–¹æ³•
function customRequire(moduleName) {
  // è·¯å¾„åˆ†æ,è§£æå‡ºæ¨¡å—çš„ç»å¯¹è·¯å¾„
  const absPath = Module._resolveFilename(moduleName)
}
```

### 4.æ‰§è¡Œç¼“å­˜ä¼˜å…ˆåŸåˆ™,åŠ è½½æ–‡ä»¶çš„æ—¶å€™ä¼˜å…ˆä»ç¼“å­˜ä¸­åŠ è½½
```js
// åˆ›å»ºè‡ªå®šä¹‰çš„requireæ–¹æ³•
function customRequire(moduleName) {
  // è·¯å¾„åˆ†æ,è§£æå‡ºæ¨¡å—çš„ç»å¯¹è·¯å¾„
  const absPath = Module._resolveFilename(moduleName)
  // ç¼“å­˜ä¼˜å…ˆåŸåˆ™,åŠ è½½æ–‡ä»¶çš„æ—¶å€™ä¼˜å…ˆä»ç¼“å­˜ä¸­åŠ è½½
  const cacheModel = Module._cache[absPath]
  if (cacheModel) return cacheModel.exports
}
```

### 5.æ‰§è¡Œåˆ›å»ºç©ºå¯¹è±¡ç›®æ ‡åŠ è½½æ¨¡å—æ“ä½œ(ä½¿ç”¨ç»å¯¹è·¯å¾„ä½œä¸ºæ¨¡å—çš„id)
```js
// å®šä¹‰ç©ºå¯¹è±¡,ç”¨äºå­˜å‚¨ç¼“å­˜çš„æ¨¡å—
Module._cache = {}

// åˆ›å»ºè‡ªå®šä¹‰çš„requireæ–¹æ³•
function customRequire(moduleName) {
  // è·¯å¾„åˆ†æ,è§£æå‡ºæ¨¡å—çš„ç»å¯¹è·¯å¾„
  const absPath = Module._resolveFilename(moduleName)
  // ç¼“å­˜ä¼˜å…ˆåŸåˆ™,åŠ è½½æ–‡ä»¶çš„æ—¶å€™ä¼˜å…ˆä»ç¼“å­˜ä¸­åŠ è½½
  const cacheModel = Module._cache[absPath]
  if (cacheModel) return cacheModel.exports
  
  // åˆ›å»ºç©ºå¯¹è±¡ç›®æ ‡åŠ è½½æ¨¡å—(ä½¿ç”¨ç»å¯¹è·¯å¾„ä½œä¸ºæ¨¡å—çš„id)
  let module = new Module(absPath)
  
  // å°†å·²åŠ è½½çš„æ¨¡å—ç¼“å­˜èµ·æ¥
  Module._cache[absPath] = module
}
```

### 6.æ‰§è¡Œæ¨¡å—çš„æ‰§è¡ŒåŠ è½½(ç¼–è¯‘æ‰§è¡Œ)
```js
// åœ¨moduleç±»çš„åŸå‹é“¾ä¸Šæ–°å¢loadæ–¹æ³•,ç”¨äºåŠ è½½æ¨¡å—
Module.prototype.load = function () {
  // è·å–å½“å‰æ¨¡å—çš„åç¼€å
  const extName = path.extname(this.id)
  // æ ¹æ®åç¼€åè°ƒç”¨å¯¹åº”çš„åŠ è½½å‡½æ•°
  Module._extensions[extName](this)
}

// è¿™é‡Œå®šä¹‰ä¸åŒæ–‡ä»¶çš„ä¸åŒåŠ è½½ä¸å¤„ç†æ–¹æ³•
Module._extensions = {
  '.js'(module) {
    // è¯»å–module.idå¯¹åº”çš„æ–‡ä»¶å†…å®¹(è¿™é‡Œçš„idå¯¹åº”çš„æ˜¯éœ€è¦è¯»å–çš„æ–‡ä»¶çš„ç»å¯¹è·¯å¾„)
    let content = fs.readFileSync(module.id, 'utf8')

    // åŒ…è£…å†…å®¹,ä½¿å…¶æˆä¸ºä¸€ä¸ªå‡½æ•°,ä¸»è¦ä½œç”¨å°±æ˜¯ä¸ºäº†è®©åŠ è½½çš„æ¨¡å—ä¸­å¯ä»¥ä½¿ç”¨ä¸€äº›å…¨å±€å˜é‡
    content = Module.wrapper[0] + content + Module.wrapper[1]

    // ä½¿ç”¨VMæ¨¡å—,å°†å­—ç¬¦ä¸²å†…å®¹å˜ä¸ºä¸€ä¸ªå‡½æ•°
    const compileFn = vm.runInThisContext(content)

    // å®šä¹‰ä¸Šæ–¹åˆ›å»ºçš„å‡½æ•°çš„å½¢å‚å¯¹åº”çš„å®å‚
    let exports = module.exports // è¿™é‡Œçš„module.exportså°±æ˜¯æ¥æ”¶åˆ°çš„å½¢å‚,Moduleçš„å®ä¾‹åŒ–å¯¹è±¡å¯¹exportsé™æ€å±æ€§
    let filename = module.id
    let dirname = path.dirname(module.id)

    // è°ƒç”¨å‡½æ•°,è¿™é‡Œä½¿ç”¨callæ–¹æ³•,
    // 1.å°†thisæŒ‡å‘module.exports,callæ–¹æ³•çš„ç¬¬ä¸€ä¸ªå€¼å°±æ˜¯é‡æ–°æŒ‡å‘çš„this
    // 2.æ­¤æ—¶è¢«åŠ è½½çš„æ¨¡å—ä¸­å°±å¯ä»¥ä½¿ç”¨module.exports,æ‰€ä»¥è¢«åŠ è½½æ¨¡å—ä¸­çš„å˜é‡å°±å¯ä»¥å­˜å‚¨åˆ°module.exportsä¸­
    // 3.ç„¶åå°†å…¶ä»–çš„å‚æ•°ä¼ é€’ç»™å‡½æ•°
    // 4.åŸºäºcallçš„ç‰¹æ€§,ä¼šç«‹å³æ‰§è¡Œæ­¤å‡½æ•°
    compileFn.call(exports, exports, customRequire, module, filename, dirname)

    // è¿”å›è¢«æ”¹åŠ¨åçš„module.exports
    return module.exports
  },
  '.json'(module) {
    // è¯»å–module.idå¯¹åº”çš„æ–‡ä»¶å†…å®¹(è¿™é‡Œçš„idå¯¹åº”çš„æ˜¯éœ€è¦è¯»å–çš„æ–‡ä»¶çš„ç»å¯¹è·¯å¾„)
    let content = fs.readFileSync(module.id, 'utf8')

    // å°†è¯»å–åˆ°çš„å†…å®¹å˜ä¸ºä¸€ä¸ªå¯¹è±¡
    content = JSON.parse(content)

    // å°†è¯»å–åˆ°çš„å†…å®¹èµ‹å€¼ç»™module.exports
    module.exports = content
  },
  // ...
}

// å®šä¹‰ç©ºå¯¹è±¡,ç”¨äºå­˜å‚¨ç¼“å­˜çš„æ¨¡å—
Module._cache = {}

// åˆ›å»ºè‡ªå®šä¹‰çš„requireæ–¹æ³•
function customRequire(moduleName) {
  // è·¯å¾„åˆ†æ,è§£æå‡ºæ¨¡å—çš„ç»å¯¹è·¯å¾„
  const absPath = Module._resolveFilename(moduleName)
  // ç¼“å­˜ä¼˜å…ˆåŸåˆ™,åŠ è½½æ–‡ä»¶çš„æ—¶å€™ä¼˜å…ˆä»ç¼“å­˜ä¸­åŠ è½½
  const cacheModel = Module._cache[absPath]
  if (cacheModel) return cacheModel.exports
  
  // åˆ›å»ºç©ºå¯¹è±¡ç›®æ ‡åŠ è½½æ¨¡å—(ä½¿ç”¨ç»å¯¹è·¯å¾„ä½œä¸ºæ¨¡å—çš„id)
  let module = new Module(absPath)
  
  // å°†å·²åŠ è½½çš„æ¨¡å—ç¼“å­˜èµ·æ¥
  Module._cache[absPath] = module
  
  // æ‰§è¡ŒåŠ è½½(ç¼–è¯‘æ‰§è¡Œ)
  module.load()
  
  // è¿”å›æ¨¡å—åŠ è½½åçš„ç»“æœ(æ³¨æ„,ä¸èƒ½å°†idä¹Ÿè¿”å›å‡ºå»)
  return module.exports
}
```

### 7.æµ‹è¯•è‡ªå®šä¹‰requireæ–¹æ³•çš„æ•ˆæœå¦‚ä½•
```js
// ...ä¸Šæ–¹ä»£ç 
// ä½¿ç”¨è‡ªå®šä¹‰æ¨¡å—åŠ è½½jsæ–‡ä»¶
const obj1 = customRequire('./æµ‹è¯•ä½¿ç”¨æ–‡ä»¶/æµ‹è¯•ä½¿ç”¨js')
console.log('æ¥æ”¶åˆ°ä½¿ç”¨customRequireæ¨¡å—å¯¼å…¥çš„jsæ–‡ä»¶ä¸­å¯¼å‡ºçš„å†…å®¹', obj1)

// ä½¿ç”¨è‡ªå®šä¹‰æ¨¡å—åŠ è½½jsonæ–‡ä»¶
const obj2 = customRequire('./æµ‹è¯•ä½¿ç”¨æ–‡ä»¶/æµ‹è¯•ä½¿ç”¨json')
console.log('æ¥æ”¶åˆ°ä½¿ç”¨customRequireæ¨¡å—å¯¼å…¥çš„jsonæ–‡ä»¶ä¸­å¯¼å‡ºçš„å†…å®¹', obj2)

// é‡å¤åŠ è½½ç›¸åŒæ–‡ä»¶å†…å®¹,è§‚å¯Ÿæ˜¯å¦ä»ç¼“å­˜ä¸­è¯»å–
const obj3 = customRequire('./æµ‹è¯•ä½¿ç”¨æ–‡ä»¶/æµ‹è¯•ä½¿ç”¨js')
console.log('æ¥æ”¶åˆ°ä½¿ç”¨customRequireæ¨¡å—å¯¼å…¥çš„jsæ–‡ä»¶ä¸­å¯¼å‡ºçš„å†…å®¹', obj3)
```

## 5.æ•´ä½“ä»£ç 
```js
// å¯¼å…¥æ‰€éœ€çš„æ¨¡å—
const fs = require('fs')
const path = require('path')
const vm = require('vm')

// åˆ›å»ºä¸€ä¸ªModuleç±»,ç”¨äºå­˜å‚¨æ¨¡å—ä¿¡æ¯,ä»¥åŠæŒ‚è½½ä¸€äº›è¾…åŠ©æ–¹æ³•
class Module {
  constructor(id) {
    this.id = id
    this.exports = {}
  }
}

// åœ¨moduleç±»çš„åŸå‹é“¾ä¸Šæ–°å¢loadæ–¹æ³•,ç”¨äºåŠ è½½æ¨¡å—
Module.prototype.load = function () {
  // è·å–å½“å‰æ¨¡å—çš„åç¼€å
  const extName = path.extname(this.id)
  // æ ¹æ®åç¼€åè°ƒç”¨å¯¹åº”çš„åŠ è½½å‡½æ•°
  Module._extensions[extName](this)
}

// ç»™moduleç±»æ·»åŠ ä¸€ä¸ªé™æ€å±æ€§,ç”¨äºè¡¨ç¤ºæ¨¡å—çš„åŠ è½½å‡½æ•°ä»¥åŠæ¨¡å—åç¼€çš„åŠ è½½é¡ºåº
Module._extensions = {
  '.js'(module) {
    // è¯»å–module.idå¯¹åº”çš„æ–‡ä»¶å†…å®¹(è¿™é‡Œçš„idå¯¹åº”çš„æ˜¯éœ€è¦è¯»å–çš„æ–‡ä»¶çš„ç»å¯¹è·¯å¾„)
    let content = fs.readFileSync(module.id, 'utf8')

    // åŒ…è£…å†…å®¹,ä½¿å…¶æˆä¸ºä¸€ä¸ªå‡½æ•°,ä¸»è¦ä½œç”¨å°±æ˜¯ä¸ºäº†è®©åŠ è½½çš„æ¨¡å—ä¸­å¯ä»¥ä½¿ç”¨ä¸€äº›å…¨å±€å˜é‡
    content = Module.wrapper[0] + content + Module.wrapper[1]

    // ä½¿ç”¨VMæ¨¡å—,å°†å­—ç¬¦ä¸²å†…å®¹å˜ä¸ºä¸€ä¸ªå‡½æ•°
    const compileFn = vm.runInThisContext(content)

    // å®šä¹‰ä¸Šæ–¹åˆ›å»ºçš„å‡½æ•°çš„å½¢å‚å¯¹åº”çš„å®å‚
    let exports = module.exports // è¿™é‡Œçš„module.exportså°±æ˜¯æ¥æ”¶åˆ°çš„å½¢å‚,Moduleçš„å®ä¾‹åŒ–å¯¹è±¡å¯¹exportsé™æ€å±æ€§
    let filename = module.id
    let dirname = path.dirname(module.id)

    // è°ƒç”¨å‡½æ•°,è¿™é‡Œä½¿ç”¨callæ–¹æ³•,
    // 1.å°†thisæŒ‡å‘module.exports,callæ–¹æ³•çš„ç¬¬ä¸€ä¸ªå€¼å°±æ˜¯é‡æ–°æŒ‡å‘çš„this
    // 2.æ­¤æ—¶è¢«åŠ è½½çš„æ¨¡å—ä¸­å°±å¯ä»¥ä½¿ç”¨module.exports,æ‰€ä»¥è¢«åŠ è½½æ¨¡å—ä¸­çš„å˜é‡å°±å¯ä»¥å­˜å‚¨åˆ°module.exportsä¸­
    // 3.ç„¶åå°†å…¶ä»–çš„å‚æ•°ä¼ é€’ç»™å‡½æ•°
    // 4.åŸºäºcallçš„ç‰¹æ€§,ä¼šç«‹å³æ‰§è¡Œæ­¤å‡½æ•°
    compileFn.call(exports, exports, customRequire, module, filename, dirname)

    // è¿”å›è¢«æ”¹åŠ¨åçš„module.exports
    return module.exports
  },
  '.json'(module) {
    // è¯»å–module.idå¯¹åº”çš„æ–‡ä»¶å†…å®¹(è¿™é‡Œçš„idå¯¹åº”çš„æ˜¯éœ€è¦è¯»å–çš„æ–‡ä»¶çš„ç»å¯¹è·¯å¾„)
    let content = fs.readFileSync(module.id, 'utf8')

    // å°†è¯»å–åˆ°çš„å†…å®¹å˜ä¸ºä¸€ä¸ªå¯¹è±¡
    content = JSON.parse(content)

    // å°†è¯»å–åˆ°çš„å†…å®¹èµ‹å€¼ç»™module.exports
    module.exports = content
  },
  // ...
}

// å®šä¹‰ä¸€ä¸ªæ•°ç»„,ç”¨äºå­˜å‚¨åŒ…è£…å†…å®¹
Module.wrapper = [
  "(function(exports, require, module, __filename, __dirname) {\n",
  "\n});"
]

// åˆ›å»ºè¾…åŠ©æ–¹æ³•,ç”¨äºè§£æå¯¼å…¥æ¨¡å—çš„ç»å¯¹è·¯å¾„
Module._resolveFilename = (moduleName) => {
  // è·å–å½“å‰æ¨¡å—çš„ç»å¯¹è·¯å¾„
  let filePath = path.resolve(__dirname, moduleName)
  // è·å–å½“å‰æ¨¡å—çš„åç¼€å
  const extName = path.extname(moduleName)

  // åˆ¤æ–­æ–‡ä»¶æ˜¯å¦å­˜åœ¨
  if (!fs.existsSync(filePath)) {
    // å¦‚æœæ–‡ä»¶ä¸å­˜åœ¨,åˆ™æŒ‰ç…§é¡ºåºæŸ¥æ‰¾åç¼€å
    const keys = Object.keys(Module._extensions)
    // æ–‡ä»¶æ˜¯å¦å­˜åœ¨æ ‡è¯†
    let flag = false
    for (let i = 0; i < keys.length; i++) {
      // è·å–å½“å‰å¾ªç¯çš„åç¼€å
      const currentExtName = keys[i]
      // æ‹¼æ¥åç¼€å
      const currentFilePath = filePath + currentExtName
      // åˆ¤æ–­æ‹¼æ¥åç¼€åä¹‹åçš„æ–‡ä»¶è·¯å¾„æ˜¯å¦å­˜åœ¨
      if (fs.existsSync(currentFilePath)) {
        // å¦‚æœå­˜åœ¨,åˆ™å°†å½“å‰æ–‡ä»¶è·¯å¾„èµ‹å€¼ç»™filePath
        filePath = currentFilePath
        // å°†æ–‡ä»¶æ˜¯å¦å­˜åœ¨æ ‡è¯†è®¾ç½®ä¸ºtrue
        flag = true
        // ç»ˆæ­¢å¾ªç¯
        break
      }
    }
    // å¦‚æœä¸å­˜åœ¨,åˆ™è¿›è¡ŒæŠ¥é”™
    if (!flag) {
      throw new Error(`${moduleName} is not exists`)
    }
  }

  // è¿”å›å¤„ç†åå¾—åˆ°çš„æ–‡ä»¶çš„ç»å¯¹è·¯å¾„
  return filePath
}

// å®šä¹‰ç©ºå¯¹è±¡,ç”¨äºå­˜å‚¨ç¼“å­˜çš„æ¨¡å—
Module._cache = {}

// åˆ›å»ºè‡ªå®šä¹‰çš„requireæ–¹æ³•
function customRequire(moduleName) {
  // 1.è·¯å¾„åˆ†æ,è§£æå‡ºæ¨¡å—çš„ç»å¯¹è·¯å¾„
  const absPath = Module._resolveFilename(moduleName)

  // 2.ç¼“å­˜ä¼˜å…ˆåŸåˆ™,åŠ è½½æ–‡ä»¶çš„æ—¶å€™ä¼˜å…ˆä»ç¼“å­˜ä¸­åŠ è½½
  const cacheModel = Module._cache[absPath]
  if (cacheModel) return cacheModel.exports

  // 3.åˆ›å»ºç©ºå¯¹è±¡ç›®æ ‡åŠ è½½æ¨¡å—(ä½¿ç”¨ç»å¯¹è·¯å¾„ä½œä¸ºæ¨¡å—çš„id)
  let module = new Module(absPath)

  // 4.å°†å·²åŠ è½½çš„æ¨¡å—ç¼“å­˜èµ·æ¥
  Module._cache[absPath] = module

  // 5.æ‰§è¡ŒåŠ è½½(ç¼–è¯‘æ‰§è¡Œ)
  module.load()

  // 6.è¿”å›æ¨¡å—åŠ è½½åçš„ç»“æœ(æ³¨æ„,ä¸èƒ½å°†idä¹Ÿè¿”å›å‡ºå»)
  return module.exports
}

// ä½¿ç”¨è‡ªå®šä¹‰æ¨¡å—åŠ è½½jsæ–‡ä»¶
const obj1 = customRequire('./æµ‹è¯•ä½¿ç”¨æ–‡ä»¶/æµ‹è¯•ä½¿ç”¨js')
console.log('æ¥æ”¶åˆ°ä½¿ç”¨customRequireæ¨¡å—å¯¼å…¥çš„jsæ–‡ä»¶ä¸­å¯¼å‡ºçš„å†…å®¹', obj1)

// ä½¿ç”¨è‡ªå®šä¹‰æ¨¡å—åŠ è½½jsonæ–‡ä»¶
const obj2 = customRequire('./æµ‹è¯•ä½¿ç”¨æ–‡ä»¶/æµ‹è¯•ä½¿ç”¨json')
console.log('æ¥æ”¶åˆ°ä½¿ç”¨customRequireæ¨¡å—å¯¼å…¥çš„jsonæ–‡ä»¶ä¸­å¯¼å‡ºçš„å†…å®¹', obj2)

// é‡å¤åŠ è½½ç›¸åŒæ–‡ä»¶å†…å®¹,è§‚å¯Ÿæ˜¯å¦ä»ç¼“å­˜ä¸­è¯»å–
const obj3 = customRequire('./æµ‹è¯•ä½¿ç”¨æ–‡ä»¶/æµ‹è¯•ä½¿ç”¨js')
console.log('æ¥æ”¶åˆ°ä½¿ç”¨customRequireæ¨¡å—å¯¼å…¥çš„jsæ–‡ä»¶ä¸­å¯¼å‡ºçš„å†…å®¹', obj3)
```

## 6.æ€»ç»“
æœ¬ç¯‡æ–‡ç« è§£æäº†requireçš„å¤§è‡´æµç¨‹(åŸrequireè‚¯å®šä¸æ­¢è¿™ä¹ˆå¤šä»£ç ä¸åŠŸèƒ½çš„,å¤æ‚åº¦è¦å¤šçš„å¤š,è¿™é‡Œåªæ˜¯å¤§è‡´å®ç°æ•ˆæœ),ä¸»è¦ç”¨åˆ°äº†`fs`,`path`,`vm`æ¨¡å—,å¦‚æœæœ‰ä»€ä¹ˆé—®é¢˜æˆ–è€…å¥½çš„å»ºè®®,æ¬¢è¿ç§ä¿¡æˆ–è¯„è®ºæå‡º!ğŸ˜