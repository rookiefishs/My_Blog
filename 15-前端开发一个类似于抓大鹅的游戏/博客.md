# å‰ç«¯å¼€å‘ä¸€ä¸ªç±»ä¼¼äºæŠ“å¤§é¹…çš„æ¸¸æˆ?ğŸ§



## 1. å‰è¨€
#### è¿™å‡ å‘¨,å¾®ä¿¡é‡Œç»å¸¸æœ‰äººåˆ†äº«æŠ“å¤§é¹…çš„å°æ¸¸æˆ,æˆ‘ä¹Ÿè¯•ç€ç©äº†ä¸€ä¼š,å¾ˆä¸Šå¤´,ç•Œé¢åˆ¶ä½œç²¾è‰¯,æ¸¸æˆéŸ³æ•ˆä¹Ÿå¾ˆå¥½

**è§£æåŸç†**:å„ä¸ª3Dç‰©ä½“ä¹‹é—´ç›¸äº’ç¢°æ’,æ”¾åœ¨ä¸€ä¸ªå¤§ç›’å­ä¸­,ç„¶åé€‰å–ç‰©ä½“,å°†ç‰©ä½“ä»ç›’å­ä¸­æŠ½å–å‡ºæ¥,æŠ½å–ä¸‰ä¸ªç›¸åŒçš„ç‰©ä½“åˆ™å¯ä»¥è¿›è¡Œå¯¹åº”çš„æ¶ˆé™¤,å½“æŠ½å–ç‰©ä½“çš„æ ¼å­å ç”¨å®Œæ¯•æ—¶å°±è¡¨ç¤ºæ¸¸æˆå¤±è´¥äº†
![æ¸¸æˆæˆªå›¾](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/d7434314e2a642f39dde002ef2896863~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=1080&h=2400&s=1157486&e=jpg&b=e17a8e)

æ—¢ç„¶æ¸¸æˆçš„åŸç†å·²ç»å¤§æ¦‚è§£æå‡ºæ¥äº†,é‚£ä¹ˆå®ç°èµ·æ¥ä¹Ÿå°±æ˜¯æŒ‰éƒ¨å°±ç­äº†,æœ¬ç¯‡æ–‡ç« å°±æ˜¯ä½¿ç”¨å‰ç«¯æŠ€æœ¯æ ˆå®ç°ä¸€ä¸ªç±»ä¼¼çš„å°æ¸¸æˆ,å½“ç„¶,åˆ¶ä½œè‚¯å®šæ²¡æœ‰è¿™ä¹ˆç²¾è‰¯,åªæ˜¯ä½¿ç”¨å¯¹åº”æŠ€æœ¯æ ˆå®ç°ç±»ä¼¼çš„æ•ˆæœè€Œå·²

**æœ€ç»ˆæ•ˆæœå›¾:**
![æœ€ç»ˆæ•ˆæœå›¾](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/3473d62d400c4c5992a9c5aaad185a1a~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=1920&h=911&s=148751&e=png&b=000000)

## 2. æŠ€æœ¯æ ˆ
> `Vue3 + Vite + Threejs + Cannon.js`

## 3. æºç ä»¥åŠæµç¨‹
```js
// 1. æ­å»ºä¸€ä¸ªVue3+Viteé¡¹ç›®,åœ¨æ­¤ä¸åšè¿‡å¤šèµ˜è¿°
// 2. ä¸‹è½½Threejsä¸Cannon.js
// 3. å®ç°æµç¨‹
//  3-1: åˆ›å»ºThreejsçš„3Dç¯å¢ƒä¸Cannon.jsç¯å¢ƒ(Cannonjsåº“ä¸»è¦ç”¨äºç‰©ç†ä»¿çœŸ3Dä¸–ç•Œçš„æ¨¡å‹,å¯ä»¥ä¸ºç‰©ä½“æ·»åŠ ç¢°æ’ç‰¹æ€§)
//  3-2: Threejsä¸Cannonjeåˆ†åˆ«åˆ›å»ºäº”ä¸ªæ–¹å‘çš„å¹³é¢,ç•™å‡ºä¸Šæ–¹çš„å¼€å£ä½ç½®,åŒ…å›´å®ç°ä¸€ä¸ªå¤§ç›’å­
//  3-3: åˆ›å»ºè‡ªå®šä¹‰çš„ç‰©ä½“,æœ¬æ¡ˆä¾‹ä¸­è‡ªå®šä¹‰äº†åœ†æŸ±ä½“,çƒä½“,ç«‹æ–¹ä½“ä¸‰ç§ç‰©ä½“
//  3-4: åœ¨åˆ›å»ºThreejsç‰©ä½“çš„åŒæ—¶åˆ›å»ºä¸€ä¸ªCannonjsçš„ç‰©ä½“,åŒæ—¶ä¸æ–­æ›´æ–°Threejsçš„ç‰©ä½“çš„ä½ç½®ä¸ºCannonjsåˆ›å»ºçš„ç‰©ä½“çš„ä½ç½®,è¿™æ ·å°±å¯ä»¥ä¸ºThreejsç”Ÿæˆçš„ç‰©ä½“æ·»åŠ ç¢°æ’ç‰¹æ€§
//  3-5: ç”ŸæˆæŒ‡å®šæ•°é‡çš„ç›’å­,å¹¶ä¸”ä¸ºThreejsæ·»åŠ ç›‘å¬æ¨¡å‹ç‚¹å‡»äº‹ä»¶,ç‚¹å‡»æ¨¡å‹æ—¶åœ¨ç›’å­ä¸­åˆ é™¤æ¨¡å‹,åŒæ—¶åœ¨æ ¼å­ä¸­å¡«å……ä¸€ä¸ªå¯¹åº”çš„ç‰©ä½“å›¾ç‰‡
//  3-6: æ£€æµ‹æ ¼å­æ˜¯å¦å æ»¡,å¦‚æœå æ»¡åˆ™è¡¨ç¤ºæ¸¸æˆå¤±è´¥,åä¹‹å¦‚æœé€‰å–çš„æ¨¡å‹è¢«æ¸…ç©ºåˆ™è¡¨ç¤ºæ¸¸æˆæˆåŠŸ!

// æºç åˆ†äº«:
<!--
 * @Author: wangZhiyu <w3209605851@163.com>
 * @Date: 2024-05-09 15:27:54
 * @LastEditTime: 2024-05-12 00:42:07
 * @LastEditors: wangZhiyu <w3209605851@163.com>
-->
<template>
  <div class="boxList">
    <div class="boxItem" v-for="item in boxNum">
      <img v-if="item.type" :src="cubeImg[item.type]" alt="" />
    </div>
  </div>
</template>

<script setup>
import { onMounted, ref } from 'vue';
// å¯¼å…¥THREEJS
import * as THREE from 'three';
// å¯¼å…¥THREEJSçš„æ§åˆ¶å™¨
import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
// THREEJSçš„æ€§èƒ½ç›‘è§†å™¨
import Stats from 'three/examples/jsm/libs/stats.module.js';
// è¾…åŠ©æ–¹æ³•,ç”¨äºç›‘å¬é¡µé¢å°ºå¯¸å˜åŒ–,å®æ—¶æ›´æ–°3Dåœºæ™¯
import { listenResize } from './utils/index';
// Debuggerå·¥å…·
import * as dat from 'lil-gui';
// åœ¨3Dåœºæ™¯ä¸­è¿›è¡Œç‰©ç†ä¸–ç•Œçš„ç¬¬ä¸‰æ–¹åº“
import * as CANNON from 'cannon-es';
// ç‰©ç†ä¸–ç•ŒDebuggerè°ƒè¯•å·¥å…·
import CannonDebugger from 'cannon-es-debugger';
import { ElMessageBox } from 'element-plus';

// åœ†æŸ±ä½“å›¾ç‰‡
import cylinderImg from './assets/image/cylinder.png';
// ç«‹æ–¹ä½“å›¾ç‰‡
import boxImg from './assets/image/box.png';
// çƒä½“
import sphereImg from './assets/image/sphere.png';

// å­˜æ”¾ç‰©ç†ä¸–ç•Œæ¨¡å‹ä¸3Dä¸–ç•Œæ¨¡å‹çš„ç›’å­å°ºå¯¸
const boxSize = 10;

// å¯ä»¥å­˜æ”¾è·å–çš„æ–¹æ ¼çš„ç›’å­æ•°é‡
let boxNum = ref([
  // {
  //   // å­˜æ”¾çš„ç‰©ä½“ç±»å‹ åœ†æŸ±/çƒä½“/ç«‹æ–¹ä½“
  //   type: '',
  // },
  // {
  //   // å­˜æ”¾çš„ç‰©ä½“ç±»å‹ åœ†æŸ±/çƒä½“/ç«‹æ–¹ä½“
  //   type: '',
  // },
  {
    // å­˜æ”¾çš„ç‰©ä½“ç±»å‹ åœ†æŸ±/çƒä½“/ç«‹æ–¹ä½“
    type: '',
  },
  {
    // å­˜æ”¾çš„ç‰©ä½“ç±»å‹ åœ†æŸ±/çƒä½“/ç«‹æ–¹ä½“
    type: '',
  },
  {
    // å­˜æ”¾çš„ç‰©ä½“ç±»å‹ åœ†æŸ±/çƒä½“/ç«‹æ–¹ä½“
    type: '',
  },
  {
    // å­˜æ”¾çš„ç‰©ä½“ç±»å‹ åœ†æŸ±/çƒä½“/ç«‹æ–¹ä½“
    type: '',
  },
  {
    // å­˜æ”¾çš„ç‰©ä½“ç±»å‹ åœ†æŸ±/çƒä½“/ç«‹æ–¹ä½“
    type: '',
  },
]);

// ä¸åŒç«‹æ–¹ä½“æ‰€ä»£è¡¨çš„å›¾ç‰‡
const cubeImg = {
  cylinder: cylinderImg,
  box: boxImg,
  sphere: sphereImg,
};

// åˆ›å»ºæ€§èƒ½ç›‘è§†å™¨
let stats = new Stats();

// å­˜å‚¨å®æ—¶ç”Ÿæˆçš„ç‰©ç†ä¸–ç•Œ+3Dåœºæ™¯æ¨¡å‹
let objectsToUpdate = [];
// åˆ›å»ºä¸€ä¸ªTHREEçš„Group,å­˜æ”¾ç”Ÿæˆçš„æ¨¡å‹,ä¾¿äºåç»­è¯†åˆ«ç‚¹å‡»çš„èŒƒå›´
const group = new THREE.Group();

// åˆ›å»ºç‰©ç†ä¸–ç•Œ
const world = new CANNON.World();
// è®¾ç½®ç‰©ç†ä¸–ç•Œçš„é‡åŠ›,è¿™é‡Œè¡¨ç¤ºç‰©ç†ä¸–ç•Œçš„Yè½´æ–¹å‘è¢«æ–½åŠ äº†-100(è¿™é‡Œä»…ä»…åªæ˜¯ä¸ºäº†åˆè¯†æ—¶çš„æ•ˆæœ,åç»­ä¼šä¿®æ”¹é‡åŠ›åŠ é€Ÿåº¦)çš„é‡åŠ›åŠ é€Ÿåº¦,è¿™ä¼šä½¿ç‰©ä½“åœ¨æ¨¡æ‹Ÿä¸­æ”¶åˆ°é‡åŠ›çš„å½±å“è€Œäº§ç”Ÿä¸‹è½çš„æ•ˆæœ
world.gravity.set(0, -100, 0);
// è¿™é‡Œè®¾ç½®äº†ç‰©ç†ä¸–ç•Œçš„å¹¿ç›¸ä½ç®—æ³•,ç”¨äºåŠ é€Ÿç¢°æ’æ£€æµ‹,å¯ä»¥æœ‰æ•ˆçš„å‡å°‘éœ€è¦æ£€æµ‹ç¢°æ’çš„ç‰©ä½“çš„æ•°é‡,æé«˜æ¨¡æ‹Ÿçš„æ€§èƒ½
world.broadphase = new CANNON.SAPBroadphase(world);
// ç¦ç”¨ç‰©ç†ä¸–ç•Œåˆšä½“çš„ä¼‘çœ åŠŸèƒ½,å½“åˆšä½“å¤„äºé™æ­¢çŠ¶æ€æ—¶,Cannon.jsä¼šå°†å…¶è®¾ç½®ä¸ºä¿®æ”¹çŠ¶æ€,è™½ç„¶è¿™æ ·ä¼šå‡å°‘è®¡ç®—é‡,æé«˜æ€§èƒ½,ä½†æ˜¯è¿™å°±è¡¨ç¤ºä¸€æ—¦ç‰©ä½“åœæ­¢ç§»åŠ¨,å°±ä¸ä¼šæ”¶åˆ°ç‰©ç†ä¸–ç•Œçš„å½±å“,ä¾‹å¦‚ä¸‹è½ç­‰è¡Œä¸º
world.allowSleep = false;

// åˆ›å»ºåœºæ™¯
const scene = new THREE.Scene();
// åˆ›å»ºç›¸æœº
const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 100);
// æŒ‡å®šç›¸æœºåœ¨åœºæ™¯ä¸­çš„ä½ç½®
camera.position.set(6.54, 17.57, 0);
// å°†ç›¸æœºä»¥åŠç”Ÿæˆçš„æ¨¡å‹æ·»åŠ åˆ°åœºæ™¯ä¸­
scene.add(camera, group);

// TODO: åˆ›å»ºä¸€ä¸ªå…‰çº¿æŠ•å°„å®ä¾‹åŒ–å¯¹è±¡,å…‰çº¿æŠ•å°„ç”¨äºé¼ æ ‡æ‹¾å–(åœ¨ä¸‰ç»´ç©ºé—´ä¸­è®¡ç®—é¼ æ ‡ç§»åŠ¨ç»è¿‡äº†é‚£äº›ç‰©ä½“)
const raycaster = new THREE.Raycaster();
// é¼ æ ‡ä½ç½®å½’ä¸€åŒ–ä¹‹åçš„è®¾å¤‡åæ ‡
const pointer = new THREE.Vector2();

// åˆ›å»ºæ¸²æŸ“å™¨,å¹¶ä¸”é…ç½®ä½¿ç”¨æŠ—é”¯é½¿
const renderer = new THREE.WebGLRenderer({ antialias: true });
// æŒ‡å®šæ¸²æŸ“å™¨çš„å°ºå¯¸
renderer.setSize(window.innerWidth, window.innerHeight);
// å¼€å¯æ¸²æŸ“å™¨çš„é˜´å½±æ˜ å°„åŠŸèƒ½
renderer.shadowMap.enabled = true;

// åˆ›å»ºä¸€ä¸ªé»˜è®¤çš„ç‰©ç†ä¸–ç•Œçš„æè´¨
const defaultMaterial = new CANNON.Material('default');
// åˆ›å»ºå®æ—¶ç”Ÿæˆçš„ç«‹æ–¹ä½“çš„é»˜è®¤æè´¨
const material = new THREE.MeshStandardMaterial();

// åˆ›å»º3Dåœºæ™¯æ§åˆ¶å™¨
const controls = new OrbitControls(camera, renderer.domElement);
// è®¾ç½®åœºæ™¯æ§åˆ¶å™¨çš„è‡ªåŠ¨æ—‹è½¬
controls.autoRotate = false;
// å¯ç”¨åœºæ™¯æ§åˆ¶å™¨çš„é˜»å°¼æ•ˆæœ
controls.enableDamping = true;
// è®¾ç½®åœºæ™¯æ§åˆ¶å™¨çš„ç¼©æ”¾é€Ÿåº¦
controls.zoomSpeed = 0.3;
// è®¾ç½®æ§åˆ¶å™¨çš„ç›®æ ‡ç‚¹,æ§åˆ¶å™¨å°†ä¼šæ ¹æ®æ­¤ç›®æ ‡ç‚¹è¿›è¡Œæ—‹è½¬,ç¼©æ”¾ç­‰æ“ä½œ
controls.target = new THREE.Vector3(0, 3, 0);

// åˆ›å»ºå®æ—¶è°ƒè¯•å·¥å…·
const gui = new dat.GUI();
// é»˜è®¤å…³é—­è°ƒè¯•å™¨
gui.close()
// è°ƒè¯•å·¥å…·å†…å®¹
const guiObj = {
  // æ˜¯å¦å¼€å¯ç‰©ç†ä¸–ç•Œè°ƒè¯•å·¥å…·
  CannonDebugger: false,
  // åˆ›å»ºä¸€ä¸ªåœ†å½¢
  createSphere() {},
  // åˆ›å»ºä¸€ä¸ªç›’å­
  createBox() {},
  // åˆ›å»ºä¸€ä¸ªåœ†æŸ±
  createCylinders() {},
  // æ¸…é™¤æ‰€æœ‰åˆ›å»ºçš„3Dåœºæ™¯ä¸­çš„ç«‹æ–¹ä½“ä¸ç‰©ç†ä¸–ç•Œä¸­çš„ç‰©ç†æ¨¡å‹
  reset() {},
};

// åˆ›å»ºç‰©ç†ä¸–ç•Œçš„è°ƒè¯•å·¥å…·
const cannonDebugger = CannonDebugger(scene, world, {
  // ç›‘å¬åˆ›å»ºç‰©ç†ä¸–ç•Œä¸­çš„3Dæ¨¡å‹
  onInit(body, mesh) {
    // æ ¹æ®é…ç½®æ§åˆ¶æ˜¯å¦æ˜¾ç¤ºç‰©ç†ä¸–ç•Œä¸­çš„3Dæ¨¡å‹
    mesh.visible = guiObj.CannonDebugger;
  },
});

// åˆ›å»º3Dä¸–ç•Œä¸­çš„å¹³é¢,ä¸ç‰©ç†ä¸–ç•Œçš„å¹³é¢ä¸€èµ·å½¢æˆä¸€ä¸ªå¼€å£çš„ç›’å­
function initPlaneBox() {
  // åˆ›å»º3Dåœºæ™¯çš„å¹³é¢çš„é…ç½®
  const planeData = {
    // å¹³é¢å°ºå¯¸
    size: boxSize,
    // å¹³é¢é¢œè‰²
    color: 0xffffff,
    // æ—‹è½¬/ç¼©æ”¾/ä½ç½® å˜æ¢
    transform: [
      {
        // å¹³é¢çš„è§’åº¦è®¾ç½®
        rotation: [-Math.PI / 2, 0, 0],
        // å¹³é¢çš„ä½ç½®è®¾ç½®
        position: null,
      },
      {
        rotation: null,
        position: [0.5, boxSize / 2, -boxSize / 2],
      },
      {
        rotation: [0, -Math.PI, 0],
        position: [0.5, boxSize / 2, boxSize / 2],
      },
      { rotation: [0, -Math.PI / 2, 0], position: [boxSize / 2, boxSize / 2, 0] },
      { depth: 1, rotation: [0, Math.PI / 2, 0], position: [-boxSize / 2, boxSize / 2, 0] },
    ],
  };

  // å¾ªç¯é…ç½®,ç”Ÿæˆ3Dç«‹æ–¹ä½“(å¹³é¢)
  planeData.transform.forEach(item => {
    // åˆ›å»º3Dåœºæ™¯ä¸­çš„å¹³é¢,ç”¨äºè¡¨ç¤ºåˆ†éš”æ¿
    const plane = new THREE.Mesh(
      // åˆ›å»ºå¹³é¢ç«‹æ–¹ä½“
      new THREE.BoxGeometry(planeData.size + (item.depth || 0), planeData.size, 1),
      // åˆ›å»ºå¹³é¢æè´¨
      new THREE.MeshStandardMaterial({
        color: planeData.color,
        side: THREE.DoubleSide,
      })
    );
    plane.name = 'plane';

    // è®¾ç½®å¹³é¢çš„ä½ç½®
    item.position && plane.position.set(...item.position);
    // è®¾ç½®å¹³é¢çš„æ—‹è½¬è§’åº¦
    item.rotation && plane.rotation.set(...item.rotation);
    // è®¾ç½®å¹³é¢åå°„é˜´å½±
    plane.receiveShadow = true;
    // å°†å¹³é¢æ·»åŠ åˆ°åœºæ™¯ä¸­
    scene.add(plane);
  });
}
initPlaneBox();

// åˆ›å»ºå…¨å±€å¹³è¡Œå…‰ä»¥åŠå¹³è¡Œå…‰çš„è¾…åŠ©å¯¹è±¡
function initLight() {
  // åˆ›å»ºå¹³è¡Œå…‰
  const directionLight = new THREE.DirectionalLight();
  // è®¾ç½®å¹³è¡Œå…‰æŠ•å°„é˜´å½±
  directionLight.castShadow = true;
  // è®¾ç½®å¹³è¡Œå…‰çš„ä½ç½®
  directionLight.position.set(5, 5, 6);

  // è®¾ç½®å¹³è¡Œå…‰ç›¸æœºç¦»è§†é”¥ä½“çš„è¿‘ç«¯çš„è·ç¦»
  directionLight.shadow.camera.near = 1;
  // è®¾ç½®å¹³è¡Œå…‰ç›¸æœºç¦»è§†é”¥ä½“çš„è¿œç«¯çš„è·ç¦»
  directionLight.shadow.camera.far = 20;
  // è®¾ç½®é˜´å½±ç›¸æœºè§†é”¥ä½“çš„é¡¶éƒ¨è·ç¦»
  directionLight.shadow.camera.top = 10;
  // è®¾ç½®é˜´å½±ç›¸æœºè§†é”¥ä½“çš„å³ä¾§è·ç¦»
  directionLight.shadow.camera.right = 10;
  // è®¾ç½®é˜´å½±ç›¸æœºè§†é”¥ä½“çš„åº•éƒ¨è·ç¦»
  directionLight.shadow.camera.bottom = -10;
  // è®¾ç½®é˜´å½±ç›¸æœºè§†é”¥ä½“çš„å·¦ä¾§è·ç¦»
  directionLight.shadow.camera.left = -10;

  // åˆ›å»ºç¯å¢ƒå…‰
  const ambientLight = new THREE.AmbientLight(new THREE.Color('#ffffff'), 0.4);

  // æ·»åŠ ç¯å¢ƒå…‰+å¹³è¡Œå…‰åˆ°åœºæ™¯ä¸­
  scene.add(ambientLight, directionLight);
}
initLight();

// åˆ›å»ºç‰©ç†ä¸–ç•Œçš„å¹³é¢,è¯­Dä¸–ç•Œä¸­çš„å¹³é¢ä¸€èµ·å½¢æˆä¸€ä¸ªå¼€å£çš„ç›’å­
function initPhysicalWorldPlane() {
  // åˆ›å»ºä¸€ä¸ªé»˜è®¤çš„æ¥è§¦æè´¨å®ä¾‹
  const defaultContactMaterial = new CANNON.ContactMaterial(defaultMaterial, defaultMaterial, {
    // æ‘©æ“¦ç³»æ•°
    friction: 0.3,
    // å¼¹æ€§
    restitution: 0.3,
  });

  // å°†æ¥è§¦æè´¨åº”ç”¨äºç‰©ç†ä¸–ç•Œä¸­,å¯ä»¥ç¡®ä¿åœ¨æ¨¡æ‹Ÿä¸­æ­£ç¡®çš„å¤„ç†ç‰©ä½“ä¹‹é—´çš„ç¢°æ’,å¹¶æ ¹æ®å®šä¹‰çš„æ¥è§¦æè´¨æ¥æ¨¡æ‹Ÿç¢°æ’æ•ˆæœ
  world.addContactMaterial(defaultContactMaterial);

  // åˆ›å»ºç‰©ç†ä¸–ç•Œä¸­çš„å¹³é¢å½¢çŠ¶(å› ä¸ºCannonä¸­çš„å¹³é¢æ˜¯æ— é™å»¶ä¼¸çš„,æ‰€ä»¥è¿™é‡Œä½¿ç”¨ä¸€ä¸ªç›’å­æ¥æ›¿ä»£,ç›’å­çš„åšåº¦ä¸º0.5,å¾ˆè–„,æ¨¡æ‹Ÿå‡ºå¹³é¢çš„æ•ˆæœ)
  // const floorShape = new CANNON.Box(new CANNON.Vec3(boxSize / 2, boxSize / 2, 0.05));
  const floorShape = new CANNON.Plane();

  // è®¾ç½®ç‰©ç†ä¸–ç•Œä¸­çš„ç‰©ä½“é…ç½®
  const cannonBodyData = {
    // è®¾ç½®ç‰©ä½“çš„ç±»å‹,CANNON.Body.STATICè¡¨ç¤ºæ­¤ç‰©ä½“æ˜¯ä¸€ä¸ªé™æ€ç‰©ä½“,è¡¨ç¤ºå®ƒçš„ä½ç½®ä¸ä¼šæ”¹å˜,ä¹Ÿä¸ä¼šæ”¶åˆ°åŠ›çš„ä½œç”¨,é€šå¸¸ç”¨æ¥è¡¨ç¤ºåœ°é¢æˆ–è€…å¢™å£ç¯ä¸ä¼šç§»åŠ¨çš„ç‰©ä½“
    type: CANNON.Body.STATIC,
    // æŒ‡å®šç‰©ä½“çš„å½¢çŠ¶
    shape: floorShape,
    // æŒ‡å®šç‰©ä½“çš„æè´¨
    material: defaultMaterial,
    // æ—‹è½¬/ç¼©æ”¾/ä½ç½® å˜æ¢
    transform: [
      {
        axis: {
          rotation: [1, 0, 0],
          angle: -Math.PI / 2,
        },
        position: [0, -0.05, 0],
      },
      {
        axis: null,
        position: [0, boxSize / 2, -(boxSize / 2)],
      },
      {
        axis: {
          rotation: [0, 1, 0],
          angle: -Math.PI,
        },
        position: [0, boxSize / 2, boxSize / 2],
      },
      {
        axis: {
          rotation: [0, 1, 0],
          angle: -Math.PI / 2,
        },
        position: [boxSize / 2, boxSize / 2, 0],
      },
      {
        axis: {
          rotation: [0, 1, 0],
          angle: Math.PI / 2,
        },
        position: [-(boxSize / 2), boxSize / 2, 0],
      },
    ],
  };

  // å¾ªç¯ç”Ÿæˆç‰©ç†ä¸–ç•Œä¸­çš„ç‰©ä½“
  cannonBodyData.transform.forEach(item => {
    // åˆ›å»ºç‰©ç†ä¸–ç•Œä¸­çš„ç‰©ä½“
    const floorBody = new CANNON.Body({
      type: cannonBodyData.type,
      shape: cannonBodyData.shape,
      material: cannonBodyData.material,
    });
    // è®¾ç½®ç‰©ä½“æ—‹è½¬çš„è§’åº¦
    item.axis && floorBody.quaternion.setFromAxisAngle(new CANNON.Vec3(...item.axis.rotation), item.axis.angle);

    // è®¾ç½®ç‰©ä½“çš„ä½ç½®
    item.position && floorBody.position.set(...item.position);

    // å°†ç‰©ä½“æ·»åŠ åˆ°
    world.addBody(floorBody);
  });
}
initPhysicalWorldPlane();

// åˆ›å»ºä¸€ä¸ª3Dåœºæ™¯ä¸­çš„å°çƒ
const sphereGeometry = new THREE.SphereGeometry(1, 32, 32);

// ç”Ÿæˆä¸€ä¸ªç‰©ç†ç¯å¢ƒä¸3Dç¯å¢ƒçš„å°çƒ
const createSphere = radius => {
  // åˆ›å»ºå®æ—¶ç”Ÿæˆçš„ç«‹æ–¹ä½“çš„é»˜è®¤æè´¨
  const material = new THREE.MeshStandardMaterial({ color: '#3F51B5' });
  // åˆ›å»ºä¸€ä¸ªå°çƒæ¨¡å‹
  const mesh = new THREE.Mesh(sphereGeometry, material);
  // è®¾ç½®å°çƒæŠ•å°„é˜´å½±
  mesh.castShadow = true;
  // è®¾ç½®å°çƒçš„å°ºå¯¸
  mesh.scale.set(radius, radius, radius);
  // è®¾ç½®å°çƒä¸‹è½çš„ä½ç½®
  const position = new THREE.Vector3(getRandomNumber(-boxSize / 2 - 0.3, boxSize / 2 - 0.3), boxSize, getRandomNumber(-boxSize / 2 - 0.3, boxSize / 2 - 0.3));
  // è®¾ç½®3Dç¯å¢ƒçš„å°çƒçš„ä½ç½®
  mesh.position.copy(position);

  // å°†å°çƒæ·»åŠ åˆ°3Dåœºæ™¯çš„groupä¸­
  group.add(mesh);

  // åˆ›å»ºç‰©ç†ç¯å¢ƒä¸­çš„å°çƒ(ç‰©ç†ç¯å¢ƒä¸­çš„å°çƒè¦æ±‚ä¸çœŸå®ç¯å¢ƒä¸­çš„å°çƒä¸€æ ·å¤§å°,æ‰€ä»¥ä¸Šé¢è®¾ç½®äº†å°çƒçš„scale)
  const shape = new CANNON.Sphere(radius);
  // è·å–3Dä¸–ç•Œçš„ç›’å­çš„é¡¶ç‚¹ä¿¡æ¯
  // const vertices = sphereGeometry.attributes.position.array;
  // è·å–3Dä¸–ç•Œçš„ç›’å­çš„ä¸‰è§’é¢æ•°æ®
  // const indices = sphereGeometry.index.array;

  // ä½¿ç”¨ç›’å­çš„é¡¶ç‚¹ä¸ä¸‰è§’é¢çš„ä¿¡æ¯ç”Ÿæˆä¸€ä¸ªç‰©ç†ä¸–ç•Œçš„ç›’å­
  // const shape = new CANNON.Trimesh(vertices, indices);

  // è®¾ç½®ç‰©ç†ç¯å¢ƒä¸­å°çƒç‰©ä½“
  const body = new CANNON.Body({
    mass: 1,
    shape,
    material: defaultMaterial,
  });

  // è®¾ç½®ç‰©ç†ä¸–ç•Œçš„å°çƒç‰©ä½“ä¸3Dåœºæ™¯çš„å°çƒç‰©ä½“åœ¨åŒä¸€ä¸ªä½ç½®
  body.position.copy(position);

  // å°†å°çƒæ·»åŠ åˆ°ç‰©ç†ä¸–ç•Œä¸­
  world.addBody(body);

  // å°†3Dä¸–ç•Œä¸­çš„ç‰©ä½“å’Œç‰©ç†ä¸–ç•Œçš„ç‰©ä½“æ·»åŠ åˆ°æ•°ç»„ä¸­,æ–¹ä¾¿ç»Ÿä¸€å¤„ç†
  objectsToUpdate.push({
    mesh,
    body,
    name: 'sphere',
  });

  // ç›‘å¬ç‰©ç†ä¸–ç•Œä¸­çš„å°çƒè½åœ°å›è°ƒäº‹ä»¶
  body.addEventListener('collide', () => {
    // console.log('ç¢°æ’');
  });
};

// åˆ›å»ºä¸€ä¸ª3Dåœºæ™¯ä¸­çš„ç›’å­
const boxGeometry = new THREE.BoxGeometry(1, 1, 1);

// ç”Ÿæˆä¸€ä¸ªç‰©ç†ç¯å¢ƒä¸3Dç¯å¢ƒçš„ç›’å­
const createBoxes = (width, height, depth) => {
  // åˆ›å»ºå®æ—¶ç”Ÿæˆçš„ç«‹æ–¹ä½“çš„é»˜è®¤æè´¨
  const material = new THREE.MeshStandardMaterial({ color: '#3F51B5' });
  // åˆ›å»ºä¸€ä¸ªç›’å­æ¨¡å‹
  const mesh = new THREE.Mesh(boxGeometry, material);
  // è®¾ç½®ç›’å­æŠ•å°„é˜´å½±
  mesh.castShadow = true;
  // è®¾ç½®ç›’å­çš„å°ºå¯¸
  mesh.scale.set(width, height, depth);
  // è®¾ç½®ç›’å­ä¸‹è½çš„ä½ç½®
  const position = new THREE.Vector3(getRandomNumber(-boxSize / 2 - 0.3, boxSize / 2 - 0.3), boxSize, getRandomNumber(-boxSize / 2 - 0.3, boxSize / 2 - 0.3));
  // è®¾ç½®3Dç¯å¢ƒçš„ç›’å­çš„ä½ç½®
  mesh.position.copy(position);
  // ç›’å­æ·»åŠ åˆ°3Dç¯å¢ƒçš„groupä¸­
  group.add(mesh);
  // åˆ›å»ºä¸€ä¸ª3Dç¯å¢ƒä¸­çš„ç›’å­
  const shape = new CANNON.Box(new CANNON.Vec3(width / 2, height / 2, depth / 2));

  // è·å–3Dä¸–ç•Œçš„ç›’å­çš„é¡¶ç‚¹ä¿¡æ¯
  // const vertices = boxGeometry.attributes.position.array;

  // è·å–3Dä¸–ç•Œçš„ç›’å­çš„ä¸‰è§’é¢æ•°æ®
  // const indices = boxGeometry.index.array;

  // ä½¿ç”¨ç›’å­çš„é¡¶ç‚¹ä¸ä¸‰è§’é¢çš„ä¿¡æ¯ç”Ÿæˆä¸€ä¸ªç‰©ç†ä¸–ç•Œçš„ç›’å­
  // const shape = new CANNON.ConvexPolyhedron(vertices, indices);

  // è®¾ç½®ç‰©ç†ç¯å¢ƒä¸­ç›’å­ç‰©ä½“
  const body = new CANNON.Body({
    mass: 1,
    shape,
    material: defaultMaterial,
  });

  // è®¾ç½®ç‰©ç†ä¸–ç•Œçš„ç›’å­ç‰©ä½“ä¸3Dåœºæ™¯çš„ç›’å­ç‰©ä½“åœ¨åŒä¸€ä¸ªä½ç½®
  body.position.copy(position);

  // å°†ç›’å­æ·»åŠ åˆ°ç‰©ç†ä¸–ç•Œä¸­
  world.addBody(body);

  // å°†3Dä¸–ç•Œä¸­çš„ç‰©ä½“å’Œç‰©ç†ä¸–ç•Œçš„ç‰©ä½“æ·»åŠ åˆ°æ•°ç»„ä¸­,æ–¹ä¾¿ç»Ÿä¸€å¤„ç†
  objectsToUpdate.push({
    mesh,
    body,
    name: 'box',
  });

  // ç›‘å¬ç‰©ç†ä¸–ç•Œä¸­çš„ç›’å­è½åœ°å›è°ƒäº‹ä»¶
  body.addEventListener('collide', () => {
    // console.log('ç¢°æ’');
  });
};

// åˆ›å»ºä¸€ä¸ª3Dåœºæ™¯ä¸­çš„åœ†æŸ±ä½“
const cylinder = new THREE.CylinderGeometry(1, 1, 1, 10, 6);

// ç”Ÿæˆä¸€ä¸ªç‰©ç†ç¯å¢ƒä¸3Dç¯å¢ƒçš„åœ†æŸ±
const createCylinders = size => {
  // åˆ›å»ºå®æ—¶ç”Ÿæˆçš„ç«‹æ–¹ä½“çš„é»˜è®¤æè´¨
  const material = new THREE.MeshStandardMaterial({ color: '#3F51B5' });
  // åˆ›å»ºä¸€ä¸ªåœ†æŸ±æ¨¡å‹
  const mesh = new THREE.Mesh(cylinder, material);
  // è®¾ç½®åœ†æŸ±æŠ•å°„é˜´å½±
  mesh.castShadow = true;
  // è®¾ç½®åœ†æŸ±çš„å°ºå¯¸
  mesh.scale.set(size, size, size);
  // è®¾ç½®åœ†æŸ±ä¸‹è½çš„ä½ç½®
  const position = new THREE.Vector3(getRandomNumber(-boxSize / 2 - 0.3, boxSize / 2 - 0.3), boxSize, getRandomNumber(-boxSize / 2 - 0.3, boxSize / 2 - 0.3));
  // è®¾ç½®3Dç¯å¢ƒçš„åœ†æŸ±çš„ä½ç½®
  mesh.position.copy(position);
  // åœ†æŸ±æ·»åŠ åˆ°3Dç¯å¢ƒçš„groupä¸­
  group.add(mesh);

  // åˆ›å»ºä¸€ä¸ª3Dç¯å¢ƒä¸­çš„åœ†æŸ±ä½“
  const shape = new CANNON.Cylinder(0.5, 0.5, 1, 10);

  // è®¾ç½®ç‰©ç†ç¯å¢ƒä¸­åœ†æŸ±ç‰©ä½“
  const body = new CANNON.Body({
    mass: 1,
    shape,
    material: defaultMaterial,
  });

  // è®¾ç½®ç‰©ç†ä¸–ç•Œçš„åœ†æŸ±ç‰©ä½“ä¸3Dåœºæ™¯çš„åœ†æŸ±ç‰©ä½“åœ¨åŒä¸€ä¸ªä½ç½®
  body.position.copy(position);

  // å°†åœ†æŸ±æ·»åŠ åˆ°ç‰©ç†ä¸–ç•Œä¸­
  world.addBody(body);

  // å°†3Dä¸–ç•Œä¸­çš„ç‰©ä½“å’Œç‰©ç†ä¸–ç•Œçš„ç‰©ä½“æ·»åŠ åˆ°æ•°ç»„ä¸­,æ–¹ä¾¿ç»Ÿä¸€å¤„ç†
  objectsToUpdate.push({
    mesh,
    body,
    name: 'cylinder',
  });

  // ç›‘å¬ç‰©ç†ä¸–ç•Œä¸­çš„åœ†æŸ±è½åœ°å›è°ƒäº‹ä»¶
  body.addEventListener('collide', () => {
    // console.log('ç¢°æ’');
  });
};

// ç”Ÿæˆç‰©ä½“å¯¹è±¡çš„æ•°é‡(æ³¨æ„,æ•°é‡ä¼š*3,å› ä¸ºæœ€ç»ˆçš„è¦æ±‚æ˜¯ç”Ÿæˆçš„ç‰©ä½“çš„æ•°é‡è¦è¢«ä¸‰æ•´é™¤)
const meshNum = 20 * 3; // 90ä¸ªåœ†æŸ± çƒä½“ æ­£æ–¹ä½“

// å½“å‰ç”Ÿæˆçš„ç‰©ä½“æ•°é‡
let currentNum = 0;
let timer = setInterval(() => {
  // å½“å‰ç”Ÿæˆçš„ç‰©ä½“æ•°é‡ä¸é™åˆ¶çš„ç”Ÿæˆç‰©ä½“çš„æ•°é‡ä¸€è‡´æ—¶,åœæ­¢ç”Ÿæˆç‰©ä½“
  if (currentNum === meshNum) {
    // ä¿®æ”¹ç‰©ç†ä¸–ç•Œçš„é‡åŠ›
    world.gravity.set(0, -9.82, 0);

    return clearInterval(timer);
  }
  // æ›´æ–°å½“å‰ç”Ÿæˆçš„ç‰©ä½“æ•°é‡
  currentNum += 1;

  // ç”Ÿæˆåœ†æŸ±ç«‹æ–¹ä½“(ç‰©æµä¸–ç•Œä¸3Dä¸–ç•Œä¸€èµ·ç”Ÿæˆ)
  createCylinders(1);
  // ç”Ÿæˆçƒä½“ç«‹æ–¹ä½“(ç‰©æµä¸–ç•Œä¸3Dä¸–ç•Œä¸€èµ·ç”Ÿæˆ)
  createSphere(1);
  // ç”Ÿæˆç«‹æ–¹ä½“(ç‰©æµä¸–ç•Œä¸3Dä¸–ç•Œä¸€èµ·ç”Ÿæˆ)
  createBoxes(1, 1, 1);
}, 30);

// é‡ç½®3Dç¯å¢ƒä¸ç‰©ç†ç¯å¢ƒ
guiObj.reset = () => {
  // å¾ªç¯å·²æ·»åŠ çš„ç‰©ä½“
  objectsToUpdate.forEach(object => {
    // æ¸…é™¤ç›‘å¬è½åœ°äº‹ä»¶
    object.body.removeEventListener('collide', () => {
      console.log('æ¸…é™¤ç›‘å¬è½åœ°äº‹ä»¶');
    });
    // åœ¨ç‰©ç†ä¸–ç•Œä¸­ç§»é™¤ç‰©ä½“
    world.removeBody(object.body);
    // åœ¨3Dä¸–ç•Œä¸­ç§»é™¤ç‰©ä½“
    group.remove(object.mesh);
  });

  // æ¸…é™¤å·²æ·»åŠ ç‰©ä½“åˆ—è¡¨,è¡¨ç¤ºå½“å‰æ²¡æœ‰ä»»ä½•å·²æ·»åŠ çš„ç‰©ä½“
  objectsToUpdate.splice(0, objectsToUpdate.length);
};

// å°†ç”Ÿæˆç‰©ç†ç¯å¢ƒä¸3Dç¯å¢ƒçš„å°çƒçš„æ–¹æ³•æ·»åŠ åˆ°debuggerUIä¸­,æ–¹ä¾¿ä½¿ç”¨
guiObj.createSphere = () => {
  createSphere(1);
};

// å°†ç”Ÿæˆç‰©ç†ç¯å¢ƒä¸3Dç¯å¢ƒçš„ç›’å­çš„æ–¹æ³•æ·»åŠ åˆ°debuggerUIä¸­,æ–¹ä¾¿ä½¿ç”¨
guiObj.createBox = () => {
  createBoxes(1, 1, 1);
};

// å°†ç”Ÿæˆç‰©ç†ç¯å¢ƒä¸3Dç¯å¢ƒçš„åœ†æŸ±çš„æ–¹æ³•æ·»åŠ åˆ°debuggerUIä¸­,æ–¹ä¾¿ä½¿ç”¨
guiObj.createCylinders = () => {
  createCylinders(1);
};

// æ§åˆ¶åœºæ™¯æ§åˆ¶å™¨å¼€å¯/å…³é—­è‡ªåŠ¨æ—‹è½¬
gui.add(controls, 'autoRotate');

// è®¾ç½®æ·»åŠ çš„ç‰©ä½“æ˜¾ç¤ºæ ¼å¼ä¸ºçº¿æ¡†
gui.add(material, 'wireframe');

// æ§åˆ¶ç‰©ç†ä¸–ç•Œä¸­çš„æ¨¡å‹æ˜¾ç¤º/éšè—
gui
  .add(guiObj, 'CannonDebugger')
  .name('CannonDebugger mesh visible')
  .onChange(value => {
    guiObj.CannonDebugger = value;
  });

// æ·»åŠ å°çƒç‰©ä½“
gui.add(guiObj, 'createSphere');
// æ·»åŠ ç›’å­ç‰©ä½“
gui.add(guiObj, 'createBox');
// æ·»åŠ åœ†æŸ±ç‰©ä½“
gui.add(guiObj, 'createCylinders');
// æ¸…ç©ºç‰©ä½“
gui.add(guiObj, 'reset');

// æ¸²æŸ“ æ¸²æŸ“å™¨
function render() {
  // æ›´æ–°ç‰©ç†ä¸–ç•Œçš„debuggerå·¥å…·çš„ç½‘æ ¼æ˜¾ç¤º(ç‰©ç†ä¸–ç•Œçš„ç‰©ä½“æ˜¾ç¤ºçŠ¶æ€)
  cannonDebugger.update();

  // è®¡ç®—ç‰©ä½“çš„ä½ç½®,é€Ÿåº¦,ç¢°æ’ç­‰å±æ€§,ä»è€Œè¿›è¡Œç‰©ç†ä»¿çœŸ
  world.fixedStep();

  // æ‰§è¡Œæ¸²æŸ“å™¨æ¸²æŸ“
  renderer.render(scene, camera);

  // æ›´æ–°å¸§æ•°
  stats.update();

  // æ›´æ–°æ§åˆ¶å™¨
  controls.update();

  // æ›´æ–°3Dä¸–ç•Œä¸ç‰©ç†ä¸–ç•Œä¸­çš„ç‰©ä½“çš„ä½ç½®
  objectsToUpdate.forEach(object => {
    object.mesh.position.copy(object.body.position);
    object.mesh.quaternion.copy(object.body.quaternion);
  });

  // ä¸‹ä¸€å¸§æ¸²æŸ“ä¸­é‡æ–°æ‰§è¡Œæ­¤å‡½æ•°
  requestAnimationFrame(render);
}

// ç”Ÿæˆä¸€ä¸ªä»minåˆ°maxçš„éšæœºæ•°
function getRandomNumber(min, max) {
  return Math.random() * (max - min) + min;
}

// èŠ‚æµ
function throttle(func, delay) {
  let lastCall = 0;
  return function (...args) {
    const now = new Date().getTime();
    if (now - lastCall < delay) {
      return;
    }
    lastCall = now;
    func(...args);
  };
}

// æ¸¸æˆå¤„ç†é€»è¾‘
const gameFunc = target => {
  // è·å–å½“å‰ç¬¬ä¸€ä¸ªæ²¡æœ‰ä¿å­˜çš„typeçš„ç›’å­
  const box = boxNum.value.find(item => !item.type);

  // è®¾ç½®ç›’å­çš„type,è¡¨ç¤ºäº†ç›’å­ä¸­å­˜æ”¾çš„3Dç‰©ä½“ç±»å‹
  box.type = target.name;

  // è·å–ä¸å½“å‰ç±»å‹ç›¸åŒçš„å…¶ä»–ç±»å‹
  const sameType = boxNum.value.filter(item => item.type === target.name);

  // å¦‚æœå‘ç°ç›¸åŒç±»å‹çš„æ•°é‡ç­‰äºä¸‰ä¸ª,åˆ™å¯¹ç›¸åŒç±»å‹çš„å›¾å½¢è¿›è¡Œæ¸…é™¤
  if (sameType.length === 3) {
    sameType.forEach(item => {
      item.type = '';
    });
  }

  // ç‰©ç†ä¸–ç•Œä¸­ç§»é™¤æ¨¡å‹
  world.removeBody(target.body);
  // 3Dä¸–ç•Œä¸­ç§»é™¤æ¨¡å‹
  group.remove(target.mesh);

  // è·å–å‰©ä½™çš„ç›’å­æ•°é‡
  let surplusBox = boxNum.value.filter(item => !item.type).length;

  // å¦‚æœè¿˜æœ‰å‰©ä½™çš„ç©ºç›’å­
  if (surplusBox > 0) {
    // ä»å­˜å‚¨ç‰©ä½“çš„æ•°ç»„ä¸­ç§»é™¤
    objectsToUpdate = objectsToUpdate.filter(item => item.mesh.uuid !== target.mesh.uuid);

    // åˆ¤æ–­ç‰©ä½“æ˜¯å¦è¢«å…¨éƒ¨æ¸…é™¤
    if (objectsToUpdate.length == 0) {
      alert('æ‚¨å·²å…¨éƒ¨é€šå…³!');
    }

    // æ²¡æœ‰ç©ºä½™çš„ç©ºç›’å­äº†
  } else {
    ElMessageBox.alert('æ¸¸æˆå¤±è´¥', 'æç¤º', {
      showClose: false,
      confirmButtonText: 'ç¡®å®š',
      callback: () => {
        // é‡ç½®æ‰€æœ‰é¢œè‰²
        objectsToUpdate.forEach(item => {
          // å°†æ‰€æœ‰çº¢è‰²çš„ç‰©ä½“é‡ç½®é¢œè‰²
          if (item.mesh.material.color.getHexString() === 'ff0000') {
            item.mesh.material.color.set(new THREE.Color('#3F51B5'));
          }
        });

        // æ¸…ç©ºé€‰æ‹©çš„ç‰©ä½“åˆ—è¡¨
        boxNum.value.forEach(item => {
          item.type = '';
        });
      },
    });
  }
};

// ç›‘å¬åœºæ™¯DOMåŠ è½½å®Œæ¯•
onMounted(() => {
  // å¼€å§‹æ¸²æŸ“å™¨æ¸²æŸ“
  render();

  // å°†æ¸²æŸ“å™¨ä»¥åŠæ€§èƒ½ç›‘è§†å™¨æ·»åŠ åˆ°domä¸­
  document.getElementById('app').appendChild(renderer.domElement);
  document.getElementById('app').appendChild(stats.domElement);

  // æ£€æµ‹çª—å£å¤§å°å˜åŒ–,æ›´æ–°3Dåœºæ™¯è§†å›¾
  listenResize({ width: window.innerWidth, height: window.innerHeight }, camera, renderer);

  // ç›‘å¬é¼ æ ‡ç‚¹å‡»
  window.addEventListener('click', event => {
    // å°†é¼ æ ‡ä½ç½®å½’ä¸€åŒ–ä¸ºè®¾å¤‡åæ ‡ã€‚x å’Œ y æ–¹å‘çš„å–å€¼èŒƒå›´æ˜¯ (-1 to +1)
    pointer.x = (event.clientX / window.innerWidth) * 2 - 1;
    pointer.y = -(event.clientY / window.innerHeight) * 2 + 1;

    // ä½¿ç”¨setFromCameraæ–¹æ³•é€šè¿‡æ‘„åƒæœºå’Œé¼ æ ‡ä½ç½®æ›´æ–°å°„çº¿
    raycaster.setFromCamera(pointer, camera);

    // è®¡ç®—ç‰©ä½“å’Œå°„çº¿çš„ç„¦ç‚¹,ç¬¬ä¸€ä¸ªå‚æ•°è¡¨ç¤ºéœ€è¦æ£€æµ‹ä¸å°„çº¿ç›¸äº¤(å³å½“å‰é¼ æ ‡ç§»åŠ¨åˆ°æ­¤æ¨¡å‹ä¸Š)çš„ç‰©ä½“,ç¬¬äºŒä¸ªå‚æ•°è¡¨ç¤ºæ˜¯å¦æ£€æµ‹æ‰€æœ‰ç‰©ä½“çš„åå°,å¦åˆ™åªæ£€æµ‹å¯¹è±¡æœ¬èº«çš„ç›¸äº¤éƒ¨åˆ†
    const intersects = raycaster.intersectObjects(scene.children);

    // åˆ¤æ–­æ˜¯å¦æœ‰ç›¸äº¤çš„ç‰©ä½“
    if (intersects.length > 0) {
      // è·å–ç¬¬ä¸€ä¸ªç›¸äº¤çš„ç‰©ä½“ï¼Œå³è¢«ç‚¹å‡»çš„ç‰©ä½“
      const clickedObject = intersects[0].object;

      // åˆ¤æ–­å½“å‰é€‰ä¸­çš„ç‰©ä½“æ˜¯å¦ä¸ºgroupçš„å­çº§(ä¸ºå¤§ç›’å­ä¸­çš„å­ç‰©ä½“)
      const isGroupChildren = group.children.find(item => item.uuid === clickedObject.uuid);

      // å½“å‰ç‚¹å‡»çš„ç‰©ä½“éç›’å­å†…çš„ç‰©ä½“ä¸ç”Ÿæ•ˆ
      if (!isGroupChildren) return;

      // è·å–ç‚¹å‡»çš„3Dæ¨¡å‹çš„ç‰©ç†ä¸–ç•Œæ¨¡å‹ä¸3Dç«‹æ–¹ä½“æ¨¡å‹
      let target = objectsToUpdate.find(item => item.mesh.uuid === clickedObject.uuid);

      // æ‰§è¡Œæ¸¸æˆå¤„ç†é€»è¾‘
      gameFunc(target);
    }
  });

  // é¼ æ ‡ç§»åŠ¨å›è°ƒå‡½æ•°
  const mouseMoveFn = event => {
    // å°†é¼ æ ‡ä½ç½®å½’ä¸€åŒ–ä¸ºè®¾å¤‡åæ ‡ã€‚x å’Œ y æ–¹å‘çš„å–å€¼èŒƒå›´æ˜¯ (-1 to +1)
    pointer.x = (event.clientX / window.innerWidth) * 2 - 1;
    pointer.y = -(event.clientY / window.innerHeight) * 2 + 1;

    // ä½¿ç”¨setFromCameraæ–¹æ³•é€šè¿‡æ‘„åƒæœºå’Œé¼ æ ‡ä½ç½®æ›´æ–°å°„çº¿
    raycaster.setFromCamera(pointer, camera);

    // è®¡ç®—ç‰©ä½“å’Œå°„çº¿çš„ç„¦ç‚¹,ç¬¬ä¸€ä¸ªå‚æ•°è¡¨ç¤ºéœ€è¦æ£€æµ‹ä¸å°„çº¿ç›¸äº¤(å³å½“å‰é¼ æ ‡ç§»åŠ¨åˆ°æ­¤æ¨¡å‹ä¸Š)çš„ç‰©ä½“,ç¬¬äºŒä¸ªå‚æ•°è¡¨ç¤ºæ˜¯å¦æ£€æµ‹æ‰€æœ‰ç‰©ä½“çš„åå°,å¦åˆ™åªæ£€æµ‹å¯¹è±¡æœ¬èº«çš„ç›¸äº¤éƒ¨åˆ†
    const intersects = raycaster.intersectObjects(scene.children);

    // åˆ¤æ–­æ˜¯å¦æœ‰ç›¸äº¤çš„ç‰©ä½“
    if (intersects.length > 0) {
      // è·å–ç¬¬ä¸€ä¸ªç›¸äº¤çš„ç‰©ä½“ï¼Œå³è¢«ç‚¹å‡»çš„ç‰©ä½“
      const clickedObject = intersects[0].object;

      // åˆ¤æ–­å½“å‰é€‰ä¸­çš„ç‰©ä½“æ˜¯å¦ä¸ºgroupçš„å­çº§(ä¸ºå¤§ç›’å­ä¸­çš„å­ç‰©ä½“)
      const isGroupChildren = group.children.find(item => item.uuid === clickedObject.uuid);

      // è®¾ç½®æ‰€æœ‰çš„ç‰©ä½“çš„æè´¨ä¸ºç°è‰²
      objectsToUpdate.forEach(item => {
        if (item.mesh.material.color.getHexString() === 'ff0000') {
          // é‡ç½®é¢œè‰²
          item.mesh.material.color.set(new THREE.Color('#3F51B5'));
        }

        // å½“å‰é€‰ä¸­çš„ç‰©ä½“æ˜¯groupçš„å­çº§
        if (isGroupChildren) {
          // é«˜äº®æ˜¾ç¤ºå½“å‰é€‰ä¸­çš„ç‰©ä½“
          clickedObject.material.color.set(new THREE.Color('#f00'));
        }
      });
    }
  };

  // èŠ‚æµå¤„ç†çš„é¼ æ ‡ç§»åŠ¨å›è°ƒå‡½æ•°
  const mouseMoveFnThrottled = throttle(mouseMoveFn, 10);

  // ç›‘å¬é¼ æ ‡ç§»åŠ¨
  window.addEventListener('mousemove', mouseMoveFnThrottled);
});
</script>

<style lang="scss">
.boxList {
  position: absolute;
  bottom: 5%;
  left: 50%;
  transform: translateX(-50%);
  background-color: rgb(209, 208, 208);
  padding: 15px;
  box-sizing: border-box;
  border-radius: 10px;
  display: flex;
  justify-content: space-around;
  align-items: center;
  .boxItem {
    width: 8vmin;
    height: 8vmin;
    background-color: #fff;
    border-radius: 5px;
    display: flex;
    justify-content: center;
    align-items: center;
    overflow: hidden;
    margin: 0 10px;
    img {
      width: 100%;
      height: 100%;
    }
  }
}
</style>
```

## 4. å…³é”®ç‚¹è®²è§£:
1. å¦‚ä½•ä¸ºThreejsçš„æ¨¡å‹æ·»åŠ ç¢°æ’ç‰¹æ€§?
```js
// åœ¨threejsçš„renderæ¸²æŸ“å™¨ä¸­å°†ç¢°æ’æ¨¡å‹çš„ä½ç½®å®æ—¶æ›´æ–°åˆ°threejsç‰©ä½“çš„ä½ç½®ä¸­å³å¯

// æ¸²æŸ“ æ¸²æŸ“å™¨
function render() {
  // æ›´æ–°ç‰©ç†ä¸–ç•Œçš„debuggerå·¥å…·çš„ç½‘æ ¼æ˜¾ç¤º(ç‰©ç†ä¸–ç•Œçš„ç‰©ä½“æ˜¾ç¤ºçŠ¶æ€)
  cannonDebugger.update();

  // è®¡ç®—ç‰©ä½“çš„ä½ç½®,é€Ÿåº¦,ç¢°æ’ç­‰å±æ€§,ä»è€Œè¿›è¡Œç‰©ç†ä»¿çœŸ
  world.fixedStep();

  // æ‰§è¡Œæ¸²æŸ“å™¨æ¸²æŸ“
  renderer.render(scene, camera);

  // æ›´æ–°å¸§æ•°
  stats.update();

  // æ›´æ–°æ§åˆ¶å™¨
  controls.update();

  // æ›´æ–°3Dä¸–ç•Œä¸ç‰©ç†ä¸–ç•Œä¸­çš„ç‰©ä½“çš„ä½ç½®
  objectsToUpdate.forEach(object => {
    object.mesh.position.copy(object.body.position);
    object.mesh.quaternion.copy(object.body.quaternion);
  });

  // ä¸‹ä¸€å¸§æ¸²æŸ“ä¸­é‡æ–°æ‰§è¡Œæ­¤å‡½æ•°
  requestAnimationFrame(render);
}
```

2. å¦‚ä½•åˆ›å»ºå¯¹åº”çš„ç¢°æ’æ¨¡å‹ç‰©ä½“?
```js
// å¯ä»¥æŸ¥çœ‹Cannonjsçš„æ–‡æ¡£,æ–‡æ¡£ä¸­åˆ—ä¸¾äº†Cannonjsæ”¯æŒçš„å„ç§ç‰©ä½“,æœ¬æ–‡ä¸­é€‰å–äº†åœ†æŸ±ä½“,çƒä½“,ç«‹æ–¹ä½“ä½œä¸ºå¯ä»¥ç‚¹å‡»é€‰å–çš„ç‰©ä½“

// åˆ›å»ºä¸€ä¸ªCannonjsçš„çƒä½“ç¢°æ’æ¨¡å‹
const shape = new CANNON.Sphere(radius);
// åˆ›å»ºä¸€ä¸ªCannonjsçš„ç«‹æ–¹ä½“ç¢°æ’æ¨¡å‹
const shape = new CANNON.Box(new CANNON.Vec3(width / 2, height / 2, depth / 2));
// åˆ›å»ºä¸€ä¸ªCannonjsçš„åœ†æŸ±ä½“ç¢°æ’æ¨¡å‹
const shape = new CANNON.Cylinder(0.5, 0.5, 1, 10);
```

3. å¦‚ä½•ç›‘å¬Threejsä¸­çš„æ¨¡å‹è¢«ç‚¹å‡»?
```js
// 1. é¦–å…ˆç›‘å¬windowsçš„ç‚¹å‡»äº‹ä»¶
// 2. å°†é¼ æ ‡ç‚¹å‡»çš„ä½ç½®å½’ä¸€åŒ–ä¸ºè®¾å¤‡åæ ‡
// 3. é€šè¿‡ç›¸æœºä¸é¼ æ ‡ä½ç½®æ›´æ–°å°„çº¿
// 4. åˆ¤æ–­å°„çº¿æ˜¯å¦ä¸æ¨¡å‹ç›¸äº¤,å¦‚æœç›¸äº¤å°±è¡¨ç¤ºå½“å‰ç‚¹å‡»äº†æ­¤æ¨¡å‹

// TODO: åˆ›å»ºä¸€ä¸ªå…‰çº¿æŠ•å°„å®ä¾‹åŒ–å¯¹è±¡,å…‰çº¿æŠ•å°„ç”¨äºé¼ æ ‡æ‹¾å–(åœ¨ä¸‰ç»´ç©ºé—´ä¸­è®¡ç®—é¼ æ ‡ç§»åŠ¨ç»è¿‡äº†é‚£äº›ç‰©ä½“)
const raycaster = new THREE.Raycaster();
// é¼ æ ‡ä½ç½®å½’ä¸€åŒ–ä¹‹åçš„è®¾å¤‡åæ ‡
const pointer = new THREE.Vector2();

// ç›‘å¬é¼ æ ‡ç‚¹å‡»
window.addEventListener('click', event => {
    // å°†é¼ æ ‡ä½ç½®å½’ä¸€åŒ–ä¸ºè®¾å¤‡åæ ‡ã€‚x å’Œ y æ–¹å‘çš„å–å€¼èŒƒå›´æ˜¯ (-1 to +1)
    pointer.x = (event.clientX / window.innerWidth) * 2 - 1;
    pointer.y = -(event.clientY / window.innerHeight) * 2 + 1;

    // ä½¿ç”¨setFromCameraæ–¹æ³•é€šè¿‡æ‘„åƒæœºå’Œé¼ æ ‡ä½ç½®æ›´æ–°å°„çº¿
    raycaster.setFromCamera(pointer, camera);

    // è®¡ç®—ç‰©ä½“å’Œå°„çº¿çš„ç„¦ç‚¹,ç¬¬ä¸€ä¸ªå‚æ•°è¡¨ç¤ºéœ€è¦æ£€æµ‹ä¸å°„çº¿ç›¸äº¤(å³å½“å‰é¼ æ ‡ç§»åŠ¨åˆ°æ­¤æ¨¡å‹ä¸Š)çš„ç‰©ä½“,ç¬¬äºŒä¸ªå‚æ•°è¡¨ç¤ºæ˜¯å¦æ£€æµ‹æ‰€æœ‰ç‰©ä½“çš„åå°,å¦åˆ™åªæ£€æµ‹å¯¹è±¡æœ¬èº«çš„ç›¸äº¤éƒ¨åˆ†
    const intersects = raycaster.intersectObjects(scene.children);

    // åˆ¤æ–­æ˜¯å¦æœ‰ç›¸äº¤çš„ç‰©ä½“
    if (intersects.length > 0) {
      console.log(intersects,'é¼ æ ‡ç‚¹å‡»çš„ç‰©ä½“')
    }
  });
```

4. æˆ‘çš„ä¸€äº›ç–‘é—®,å¦‚æœæœ‰å¤§ä½¬å¯ä»¥æœ‰è§£å†³æ–¹æ¡ˆæ¬¢è¿æ²Ÿé€š

æ­£å¦‚å‰æ–‡æ‰€è¯´,åªä½¿ç”¨äº†Cannonjsçš„**åœ†æŸ±ä½“,ç«‹æ–¹ä½“,çƒä½“**,æ ¹æ®åŸç†,æ˜¯å¯ä»¥é€šè¿‡Threejsæ¨¡å‹çš„é¡¶ç‚¹ç”Ÿæˆä¸€ä¸ªå¯¹åº”çš„Cannonjsæ¨¡å‹çš„,ä½†æ˜¯æˆ‘å°è¯•äº†å¾ˆä¹…,åªèƒ½å¤Ÿåˆ›å»ºä¸€ä¸ªCannonjsæ¨¡å‹å‡ºæ¥,è¿™ä¸ªåˆ›å»ºçš„Cannonjsæ¨¡å‹æ˜¯æ— æ³•å®ç°ç¢°æ’ç‰¹æ€§çš„
```js
// æ ¹æ®æ¨¡å‹çš„é¡¶ç‚¹ä¿¡æ¯ä¸å„ä¸ªé¢ä¿¡æ¯ç”Ÿæˆä¸€ä¸ªCannonjsçš„æ¨¡å‹
const shape = new CANNON.Trimesh(vertices, indices);
// å¦‚æœä½¿ç”¨ä»¥ä¸Šçš„shape,è™½ç„¶å¯ä»¥ç”Ÿæˆä¸€ä¸ªå¯¹åº”çš„æ¨¡å‹,ä½†æ˜¯å´æ— æ³•æœ‰ç¢°æ’ç‰¹æ€§,ä¹Ÿå°±æ— æ³•æ£€æµ‹ç¢°æ’äº†
```

## 5. æ€»ç»“:
ä»¥ä¸Šå°±æ˜¯æœ¬ç¯‡æ–‡ç« çš„æ‰€æœ‰å†…å®¹äº†,æœ‰ä»»ä½•ç–‘é—®æ¬¢è¿ç§ä¿¡æˆ–è€…æ·»åŠ æˆ‘çš„ä¸ªäººwxè”ç³»æ–¹å¼: wang3209605851